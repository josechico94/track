<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî Seguimiento (UI modernizada)</title>
<link rel="icon" href="data:,">
<style>
  /* =================== THEME & TOKENS =================== */
  :root{
    --bg:#0b1220; --panel:#0f172a; --panel-2:#0b1324; --muted:#94a3b8; --text:#e2e8f0;
    --b:#1a2435; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --primary:#2563eb; --shadow:0 16px 40px rgba(0,0,0,.35);
    --focus:#7dd3fc; --ring: 0 0 0 3px rgba(125,211,252,.25);
    --radius:16px; --radius-lg:22px; --gap:16px; --gap-lg:22px;
    --font: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f3f4f6; --panel:#ffffff; --panel-2:#f8fafc; --text:#0f172a; --muted:#6b7280; --b:#e5e7eb; --shadow:0 12px 30px rgba(0,0,0,.08);
      --primary:#1d4ed8; --ok:#059669; --warn:#d97706; --err:#dc2626; --focus:#0ea5e9;
    }
  }
  [data-theme="light"]{
    --bg:#f3f4f6; --panel:#ffffff; --panel-2:#f8fafc; --text:#0f172a; --muted:#6b7280; --b:#e5e7eb; --shadow:0 12px 30px rgba(0,0,0,.08);
    --primary:#1d4ed8; --ok:#059669; --warn:#d97706; --err:#dc2626; --focus:#0ea5e9;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:var(--font);
    background: radial-gradient(90% 120% at -10% -20%, #0b1220 0%, transparent 60%),
                radial-gradient(80% 130% at 110% -10%, #0b1220 0%, transparent 60%), var(--bg);
    color:var(--text);
  }
  a{color:inherit}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* =================== TOPBAR =================== */
  .topbar{position:sticky; top:0; z-index:40; backdrop-filter: blur(10px);
    background:color-mix(in hsl, var(--bg) 85%, transparent); border-bottom:1px solid var(--b)}
  .wrap{max-width:1200px; margin:0 auto; padding:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand .logo{width:40px; height:40px; display:grid; place-items:center; border-radius:14px;
    background:linear-gradient(135deg, color-mix(in srgb, var(--panel) 80%, #000 20%), var(--panel-2)); border:1px solid var(--b); box-shadow:var(--shadow)}
  h1{font-size:18px; margin:0}
  .muted{color:var(--muted)}

  /* =================== LAYOUT =================== */
  .grid{display:grid; gap:var(--gap); grid-template-columns:1fr}
  @media(min-width:980px){ .grid{grid-template-columns:360px 1fr} }

  /* =================== CARDS =================== */
  .card{background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 30%) var(--panel);
    border:1px solid var(--b); border-radius:var(--radius-lg); padding:18px; box-shadow:var(--shadow)}
  .card h2{font-size:16px; margin:0 0 10px}

  label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
  input,select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--b); background:var(--panel-2); color:var(--text)
  }
  input::placeholder{color:#6b7a90}
  input:focus, select:focus, button:focus{outline:none; box-shadow:var(--ring); border-color:var(--focus)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  button{
    padding:10px 14px; border:1px solid var(--b); border-radius:12px; background:var(--panel-2);
    color:var(--text); cursor:pointer; transition:.18s transform ease, .15s background-color ease, .2s box-shadow ease
  }
  button:hover{transform:translateY(-1px)}
  .btn-primary{background:var(--primary); border-color:var(--primary); color:white}
  .btn-ok{background:var(--ok); border-color:var(--ok); color:white}
  .btn-warn{background:var(--warn); border-color:var(--warn); color:white}
  .btn-ghost{background:transparent}
  .btn-danger{background:var(--err); border-color:var(--err); color:white}
  .btn-icon{display:inline-grid; place-items:center; width:38px; height:38px; padding:0}
  .btn-sm{padding:8px 10px; border-radius:10px}

  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:10px}
  .search{flex:1 1 280px; display:flex; gap:8px; align-items:center}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--b); background:var(--panel-2); font-size:13px; color:var(--muted); white-space:nowrap}

  /* =================== BADGES =================== */
  .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px; letter-spacing:.2px}
  .badge.tramite{background:rgba(245,158,11,.15); color:#fbbf24; border:1px solid rgba(245,158,11,.35)}
  .badge.transito{background:rgba(59,130,246,.15); color:#93c5fd; border:1px solid rgba(59,130,246,.35)}
  .badge.entregado{background:rgba(16,185,129,.15); color:#34d399; border:1px solid rgba(16,185,129,.35)}
  .badge.devuelto{background:rgba(239,68,68,.15); color:#fca5a5; border:1px solid rgba(239,68,68,.35)}

  /* =================== TABLES =================== */
  table{width:100%; border-collapse:collapse}
  th,td{border-top:1px solid var(--b); padding:12px 10px; text-align:left; font-size:14px}
  thead th{color:var(--muted); font-weight:700; position:sticky; top:0; background:var(--panel)}
  .right{text-align:right}
  .small{font-size:12px; color:var(--muted)}
  .tbl-wrap{max-height:380px; overflow:auto; border-radius:12px; border:1px solid var(--b)}
  .row-actions{display:flex; gap:6px; justify-content:flex-end}

  /* =================== LIST (mobile fallback for table) =================== */
  @media(max-width:640px){
    .tbl-wrap table{display:none}
    .list{display:grid; gap:10px}
    .list-item{border:1px solid var(--b); background:var(--panel); border-radius:14px; padding:12px}
    .list-item .top{display:flex; justify-content:space-between; gap:8px}
    .list-item .meta{display:grid; gap:4px; margin-top:8px; color:var(--muted); font-size:12px}
    .list-item .actions{display:flex; gap:6px; justify-content:flex-end; margin-top:10px}
  }

  /* =================== TABS / FILTERS =================== */
  .seg{display:flex; gap:8px; padding:6px; background:var(--panel); border:1px solid var(--b); border-radius:999px}
  .seg button{background:transparent; border:none; padding:8px 12px; border-radius:999px; color:var(--muted); font-weight:700}
  .seg button[aria-pressed="true"]{background:var(--panel-2); color:var(--text); border:1px solid var(--b)}

  /* =================== TOASTS =================== */
  .toasts{position:fixed; right:14px; top:14px; display:flex; flex-direction:column; gap:10px; z-index:50}
  .toast{min-width:240px; max-width:400px; padding:12px 14px; border-radius:14px; border:1px solid var(--b); background:var(--panel); box-shadow:var(--shadow); display:flex; gap:10px; align-items:flex-start}
  .toast.ok{border-color:rgba(16,185,129,.6)} .toast.err{border-color:rgba(239,68,68,.6)} .toast.info{border-color:#233148}
  .toast .title{font-weight:800}
  .toast .x{margin-left:auto; opacity:.7; cursor:pointer}

  /* =================== MISC =================== */
  .empty{display:grid; place-items:center; padding:28px; color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .hint{font-size:12px; color:var(--muted)}
  .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border:1px solid var(--b); background:var(--panel-2); padding:2px 6px; border-radius:6px}
  .spinner{width:18px;height:18px;border:3px solid var(--b);border-top-color:var(--muted);border-radius:50%;animation:sp .9s linear infinite}
  @keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <!-- =================== TOPBAR =================== -->
  <div class="topbar" role="banner">
    <div class="wrap" style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
      <div class="brand" aria-label="Identidad del sitio">
        <div class="logo" aria-hidden>üõ†Ô∏è</div>
        <div>
          <h1>Admin ‚Äî Seguimiento</h1>
          <div class="muted" style="font-size:12px">Panel admin conectado a API</div>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <button id="themeToggle" class="btn-ghost btn-icon" title="Cambiar tema" aria-pressed="false">üåó</button>
        <div style="display:flex; align-items:center; gap:6px">
          <label class="muted" for="adminkey" style="margin:0; font-size:12px">Admin Key</label>
          <input id="adminkey" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:200px" autocomplete="off" aria-label="Admin Key">
          <button class="btn-ghost btn-icon" id="toggleKey" title="Mostrar/ocultar" aria-label="Mostrar u ocultar clave">üëÅÔ∏è</button>
          <span class="pill" id="keyPill" aria-live="polite">üîí Clave no guardada</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap" style="padding-top:14px">
    <div class="grid">

      <!-- =================== PANEL IZQUIERDO =================== -->
      <section class="card" aria-labelledby="formTitle">
        <h2 id="formTitle">Nueva actualizaci√≥n</h2>
        <div class="row">
          <div style="flex:1 1 100%">
            <label for="track">N√∫mero de seguimiento</label>
            <input id="track" placeholder="Ej: ABC123, 0001-BO" autocomplete="off" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1 1 100%">
            <label for="estado">Estado</label>
            <select id="estado">
              <option value="tramite">En tr√°mite</option>
              <option value="transito">En tr√°nsito</option>
              <option value="entregado">Entregado</option>
              <option value="devuelto">Devuelto</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn-primary" id="btnGuardar">Registrar / Actualizar</button>
          <button class="btn-ok" id="btnEntregar">Marcar Entregado</button>
          <button class="btn-ghost" id="btnBuscar">Buscar</button>
        </div>

        <p class="hint" style="margin-top:8px">Atajos: <span class="kbd">/</span> buscar ¬∑ <span class="kbd">n</span> nuevo ¬∑ <span class="kbd">r</span> refrescar</p>

        <hr style="border:none; border-top:1px solid var(--b); margin:16px 0">
        <h2>Detalle</h2>
        <div id="detalle" class="small">
          <div class="empty">Sin selecci√≥n.</div>
        </div>
      </section>

      <!-- =================== PANEL DERECHO =================== -->
      <section class="card" aria-labelledby="tablaTitle">
        <div class="toolbar">
          <div class="search" role="search">
            <input id="q" placeholder="Buscar por n√∫mero‚Ä¶" aria-label="Buscar por n√∫mero" />
            <span class="pill" id="countPill">0 env√≠os</span>
          </div>
          <div class="row">
            <div class="seg" role="tablist" aria-label="Filtro por estado">
              <button class="seg-btn" data-filter="all" aria-pressed="true" role="tab">Todos</button>
              <button class="seg-btn" data-filter="tramite" role="tab">Tr√°mite</button>
              <button class="seg-btn" data-filter="transito" role="tab">Tr√°nsito</button>
              <button class="seg-btn" data-filter="entregado" role="tab">Entregado</button>
              <button class="seg-btn" data-filter="devuelto" role="tab">Devuelto</button>
            </div>
            <select id="sort" title="Ordenar" aria-label="Ordenar">
              <option value="-updated">M√°s recientes</option>
              <option value="-created">Creado (desc)</option>
              <option value="created">Creado (asc)</option>
              <option value="id">ID (A‚ÜíZ)</option>
              <option value="-id">ID (Z‚ÜíA)</option>
            </select>
            <button class="btn-ghost" id="btnRefrescar" title="Refrescar">üîÑ Refrescar</button>
            <button class="btn-danger" id="btnBorrarTodo" title="Borrar todos">üóëÔ∏è Borrar todo</button>
          </div>
        </div>

        <div class="row" style="gap:16px; align-items:start; flex-wrap:wrap">
          <div style="flex:1 1 420px; min-width:320px">
            <h2 style="display:flex; justify-content:space-between; align-items:center">
              Pendientes <span class="badge tramite">Tr√°mite</span> <span class="badge transito">Tr√°nsito</span>
            </h2>
            <div class="tbl-wrap" id="wrapPend">
              <table>
                <thead><tr>
                  <th>Seguimiento</th><th>Creado</th><th>Actualizado</th><th class="right">Acciones</th>
                </tr></thead>
                <tbody id="tblPend"></tbody>
              </table>
              <div class="list" id="listPend" hidden></div>
            </div>
          </div>

          <div style="flex:1 1 420px; min-width:320px">
            <h2 style="display:flex; justify-content:space-between; align-items:center">
              Cerrados <span class="badge entregado">Entregado</span> <span class="badge devuelto">Devuelto</span>
            </h2>
            <div class="tbl-wrap" id="wrapCerr">
              <table>
                <thead><tr>
                  <th>Seguimiento</th><th>Creado</th><th>Actualizado</th><th class="right">Acciones</th>
                </tr></thead>
                <tbody id="tblCerr"></tbody>
              </table>
              <div class="list" id="listCerr" hidden></div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- TOASTS -->
  <div class="toasts" id="toasts" aria-live="polite"></div>

<script>
/* =================== API & UTILS =================== */
const API = location.origin + '/api';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const STATUS = {
  tramite: { label:'En tr√°mite', badge:'tramite' },
  transito: { label:'En tr√°nsito', badge:'transito' },
  entregado: { label:'Entregado', badge:'entregado' },
  devuelto: { label:'Devuelto', badge:'devuelto' }
};
function norm(v){ return (v||'').trim().toUpperCase(); }
function fmt(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }
function badge(s){ const d=STATUS[s]||STATUS.tramite; return `<span class="badge ${d.badge}">${d.label}</span>`; }
function toast(text, kind='info', timeout=2600){
  const box = document.createElement('div');
  box.className = `toast ${kind}`;
  box.innerHTML = `<div class="title">${kind==='ok'?'Listo':'Aviso'}</div><div style="flex:1">${text}</div><button class="x btn-ghost btn-sm" aria-label="Cerrar">‚úï</button>`;
  $('#toasts').appendChild(box);
  const close = ()=> box.remove();
  box.querySelector('.x').onclick = close;
  if(timeout) setTimeout(close, timeout);
}

function getKey(){ return sessionStorage.getItem('adminKey') || ''; }
function setKey(k){
  if(k){ sessionStorage.setItem('adminKey', k); $('#keyPill').textContent = 'üîê Clave guardada'; }
  else { sessionStorage.removeItem('adminKey'); $('#keyPill').textContent = 'üîí Clave no guardada'; }
}

/* =================== API CALLS =================== */
async function apiList(q=''){
  const r = await fetch(`${API}/tracking?q=${encodeURIComponent(q)}`, { headers:{ 'x-admin-key': getKey() }});
  if(!r.ok) throw new Error('Error listando');
  return r.json();
}
async function apiUpsert(id, status){
  let r = await fetch(`${API}/tracking/${id}`, { method:'PUT', headers:{'Content-Type':'application/json','x-admin-key':getKey()}, body:JSON.stringify({status}) });
  if(r.status===404){
    r = await fetch(`${API}/tracking`, { method:'POST', headers:{'Content-Type':'application/json','x-admin-key':getKey()}, body:JSON.stringify({id, status}) });
  }
  if(!r.ok){ const e=await r.json().catch(()=>({error:r.status})); throw new Error(e.error||'Error'); }
  return r.json();
}
async function apiSetStatus(id, status){
  const r = await fetch(`${API}/tracking/${id}`, { method:'PUT', headers:{'Content-Type':'application/json','x-admin-key':getKey()}, body:JSON.stringify({status}) });
  if(!r.ok){ const e=await r.json().catch(()=>({error:r.status})); throw new Error(e.error||'Error'); }
  return r.json();
}
async function apiDelete(id){
  const r = await fetch(`${API}/tracking/${id}`, { method:'DELETE', headers:{'x-admin-key':getKey()} });
  if(!r.ok) throw new Error('No se pudo borrar');
  return r.json();
}
async function apiDeleteAll(){
  const r = await fetch(`${API}/tracking`, { method:'DELETE', headers:{'x-admin-key':getKey()} });
  if(!r.ok) throw new Error('No se pudo borrar todo');
  return r.json();
}

/* =================== STATE =================== */
let _rows = [];
let _filter = localStorage.getItem('flt') || 'all';
let _sort = localStorage.getItem('sort') || '-updated';

/* =================== RENDER =================== */
function applyFilter(rows){
  if(_filter==='all') return rows;
  return rows.filter(r=> r.status===_filter);
}
function applySort(rows){
  const get = (r,k)=> ({
    'created': +new Date(r.createdAt||0), 'updated': +new Date(r.updatedAt||0), 'id': r.id||''
  })[k];
  const key = _sort.replace('-',''); const dir = _sort.startsWith('-') ? -1 : 1;
  return [...rows].sort((a,b)=> (get(a,key)>get(b,key)?1:-1)*dir);
}

function renderTables(rows){
  const filtered = applyFilter(rows);
  const sorted = applySort(filtered);

  const pend = sorted.filter(r=> ['tramite','transito'].includes(r.status));
  const cerr  = sorted.filter(r=> ['entregado','devuelto'].includes(r.status));

  $('#countPill').textContent = `${filtered.length} env√≠o${filtered.length===1?'':'s'}`;

  const mkRow = r => `
    <tr data-id="${r.id}">
      <td><a href="#" class="lnk mono">${r.id}</a><div class="small">${badge(r.status)}</div></td>
      <td>${fmt(r.createdAt)}</td>
      <td>${fmt(r.updatedAt)}</td>
      <td class="right">
        <div class="row-actions">
          <button class="btn-ghost btn-sm act-copiar" title="Copiar ID">üìã</button>
          <button class="btn-ok btn-sm act-entregado" title="Marcar entregado">‚úî</button>
          <button class="btn-warn btn-sm act-transito" title="Marcar en tr√°nsito">‚Üª</button>
          <button class="btn-ghost btn-sm act-tramite" title="Volver a tr√°mite">‚Ü©</button>
          <button class="btn-danger btn-sm act-borrar" title="Eliminar">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;

  const mkCard = r => `
    <div class="list-item" data-id="${r.id}">
      <div class="top">
        <div class="mono">${r.id}</div>
        ${badge(r.status)}
      </div>
      <div class="meta">
        <div><b>Creado:</b> ${fmt(r.createdAt)}</div>
        <div><b>Actualizado:</b> ${fmt(r.updatedAt)}</div>
      </div>
      <div class="actions">
        <button class="btn-ghost btn-sm act-copiar" title="Copiar ID">üìã</button>
        <button class="btn-ok btn-sm act-entregado" title="Marcar entregado">‚úî</button>
        <button class="btn-warn btn-sm act-transito" title="Marcar en tr√°nsito">‚Üª</button>
        <button class="btn-ghost btn-sm act-tramite" title="Volver a tr√°mite">‚Ü©</button>
        <button class="btn-danger btn-sm act-borrar" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>`;

  const pendHTML = pend.map(mkRow).join('') || `<tr><td colspan="4"><div class="empty">Sin pendientes.</div></td></tr>`;
  const cerrHTML  = cerr.map(mkRow).join('')  || `<tr><td colspan="4"><div class="empty">Sin cerrados.</div></td></tr>`;
  $('#tblPend').innerHTML = pendHTML;
  $('#tblCerr').innerHTML = cerrHTML;

  // Mobile cards
  $('#listPend').innerHTML = pend.map(mkCard).join('') || `<div class="empty">Sin pendientes.</div>`;
  $('#listCerr').innerHTML = cerr.map(mkCard).join('') || `<div class="empty">Sin cerrados.</div>`;

  bindRowActions('#wrapPend');
  bindRowActions('#wrapCerr');
}

function bindRowActions(containerSel){
  const root = $(containerSel);
  root.querySelectorAll('.lnk').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      const id = a.closest('[data-id]').dataset.id;
      const row = _rows.find(x=>x.id===id);
      mostrarDetalle(row);
      $('#track').value = id; $('#track').focus();
    });
  });
  root.querySelectorAll('.act-copiar').forEach(btn=>{
    btn.addEventListener('click', async ()=> {
      const id = btn.closest('[data-id]').dataset.id;
      try{ await navigator.clipboard.writeText(id); toast(`Copiado: ${id}`,'ok',1600);}catch{toast('No se pudo copiar','err');}
    });
  });
  root.querySelectorAll('.act-entregado').forEach(btn=>{
    btn.addEventListener('click', async ()=>{ const id = btn.closest('[data-id]').dataset.id; await quickSet(id,'entregado'); });
  });
  root.querySelectorAll('.act-transito').forEach(btn=>{
    btn.addEventListener('click', async ()=>{ const id = btn.closest('[data-id]').dataset.id; await quickSet(id,'transito'); });
  });
  root.querySelectorAll('.act-tramite').forEach(btn=>{
    btn.addEventListener('click', async ()=>{ const id = btn.closest('[data-id]').dataset.id; await quickSet(id,'tramite'); });
  });
  root.querySelectorAll('.act-borrar').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.closest('[data-id]').dataset.id;
      if(!confirm(`¬øEliminar "${id}"?`)) return;
      await apiDelete(id); toast(`"${id}" eliminado`,'ok'); if($('#detalle').dataset.id===id){ $('#detalle').innerHTML='<div class="empty">Sin selecci√≥n.</div>'; }
      loadAndRender();
    });
  });
}

function mostrarDetalle(o){
  if(!o){ $('#detalle').innerHTML = `<div class="empty">No encontrado.</div>`; return; }
  $('#detalle').dataset.id = o.id;
  $('#detalle').innerHTML = `
    <div style="display:grid; gap:8px; font-size:14px">
      <div><b>Seguimiento:</b> <span class="mono">${o.id}</span></div>
      <div><b>Estado:</b> ${badge(o.status)}</div>
      <div><b>Creado:</b> ${fmt(o.createdAt)}</div>
      <div><b>Actualizado:</b> ${fmt(o.updatedAt)}</div>
      <div class="row" style="margin-top:8px">
        <button class="btn-ok"    onclick="quickSet('${o.id}','entregado')">Marcar Entregado</button>
        <button class="btn-warn"  onclick="quickSet('${o.id}','transito')">Marcar En tr√°nsito</button>
        <button class="btn-ghost" onclick="quickSet('${o.id}','tramite')">Volver a tr√°mite</button>
        <button class="btn-danger" onclick="quickDelete('${o.id}')">Eliminar</button>
      </div>
    </div>`;
}
window.quickSet = async (id,st)=>{ await apiSetStatus(id,st); toast(`"${id}" ‚Üí ${STATUS[st].label}`,'ok'); loadAndRender(); }
window.quickDelete = async (id)=>{ if(!confirm(`¬øEliminar "${id}"?`))return; await apiDelete(id); toast(`"${id}" eliminado`,'ok'); $('#detalle').innerHTML='<div class="empty">Sin selecci√≥n.</div>'; loadAndRender(); }

/* =================== EVENTS & INIT =================== */
let qTimer=null;
async function loadAndRender(){
  try{
    const q = $('#q').value || '';
    $('#countPill').innerHTML = `<span class="spinner" aria-hidden></span>`;
    const rows = await apiList(q);
    _rows = rows;
    renderTables(rows);
  }catch(e){ toast('Error cargando datos','err'); }
}

// Guardar / actualizar
$('#btnGuardar').addEventListener('click', async ()=>{
  const id = norm($('#track').value); const st = $('#estado').value;
  if(!id) return toast('Ingres√° un n√∫mero v√°lido','err');
  try{ const o = await apiUpsert(id, st); toast('Guardado','ok'); mostrarDetalle(o); $('#track').value=''; loadAndRender(); }
  catch(e){ toast('Error guardando','err'); }
});
$('#btnEntregar').addEventListener('click', async ()=>{
  const id = norm($('#track').value); if(!id) return toast('Ingres√° un n√∫mero v√°lido','err');
  try{ const o = await apiSetStatus(id,'entregado'); toast('Marcado como Entregado','ok'); mostrarDetalle(o); loadAndRender(); }
  catch(e){ toast('Error actualizando','err'); }
});

// B√∫squeda y refresco
$('#btnBuscar').addEventListener('click', loadAndRender);
$('#btnRefrescar').addEventListener('click', loadAndRender);
$('#btnBorrarTodo').addEventListener('click', async ()=>{
  if(!confirm('¬øBorrar TODOS los env√≠os?')) return;
  try{ await apiDeleteAll(); toast('Todos eliminados','ok'); $('#detalle').innerHTML='<div class="empty">Sin selecci√≥n.</div>'; loadAndRender(); }
  catch(e){ toast('No se pudo borrar todo','err'); }
});
$('#q').addEventListener('input', ()=>{ clearTimeout(qTimer); qTimer=setTimeout(loadAndRender, 180); });

// Filtros y orden
$$('.seg-btn').forEach(btn=>{
  if(btn.dataset.filter===_filter) btn.setAttribute('aria-pressed','true');
  btn.addEventListener('click', ()=>{
    $$('.seg-btn').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    _filter = btn.dataset.filter; localStorage.setItem('flt', _filter); renderTables(_rows);
  });
});
$('#sort').value = _sort;
$('#sort').addEventListener('change', ()=>{ _sort = $('#sort').value; localStorage.setItem('sort', _sort); renderTables(_rows); });

// Admin Key persistente y toggle
(function initKey(){
  const saved = getKey();
  if(saved){ $('#adminkey').value = saved; $('#keyPill').textContent = 'üîê Clave guardada'; }
  $('#adminkey').addEventListener('change', ()=> setKey($('#adminkey').value.trim()));
  $('#toggleKey').addEventListener('click', ()=>{ const f = $('#adminkey'); f.type = (f.type==='password' ? 'text' : 'password'); });
})();

// Tema (dark/light) con preferencia guardada
(function initTheme(){
  const pref = localStorage.getItem('theme');
  if(pref==='light'){ document.documentElement.setAttribute('data-theme','light'); $('#themeToggle').setAttribute('aria-pressed','true'); }
  $('#themeToggle').addEventListener('click', ()=>{
    const isLight = document.documentElement.getAttribute('data-theme')==='light';
    if(isLight){ document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme','dark'); $('#themeToggle').setAttribute('aria-pressed','false'); }
    else{ document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); $('#themeToggle').setAttribute('aria-pressed','true'); }
  });
})();

// Atajos de teclado: / buscar, n nuevo, r refrescar
window.addEventListener('keydown', (e)=>{
  if(e.key==='/' && document.activeElement!==$('#q')){ e.preventDefault(); $('#q').focus(); }
  if(e.key==='n'){ $('#track').focus(); }
  if(e.key==='r'){ loadAndRender(); }
});

// Mostrar listas (cards) en m√≥viles
const mq = window.matchMedia('(max-width:640px)');
function syncMobileLists(){
  const isMobile = mq.matches;
  $('#listPend').hidden = !isMobile; $('#listCerr').hidden = !isMobile;
}
mq.addEventListener('change', syncMobileLists); syncMobileLists();

/* Primera carga */
loadAndRender();
</script>
</body>
</html>
